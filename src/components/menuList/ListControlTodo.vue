<template>
    <template v-if="isReady">
        <last-control-filter-form />

        <div v-if="!pending.personnels">
            <template v-for="habilitationPersonnel in habilitationsPersonnels" :key="habilitationPersonnel.id">
                <app-menu-item :href="'/habilitationPersonnel/' + habilitationPersonnel.id">
                    <control-todo-habilitation-item :habilitationPersonnel="habilitationPersonnel" />
                </app-menu-item>
            </template>
        </div>
        <div class="mt-2 text-center" v-else>
            <span class="spinner-border text-secondary spinner-border-lg"></span>
        </div>
        <div class="alert alert-light mx-1 my-2" v-if="noResults">
            <i class="bi bi-file-x"></i> Aucun résultat, tentez d'étendre votre recherche
        </div>

        <div class="d-grid my-2" v-if="pending.habilitationsPersonnels || isMoreAvailable">
            <button class="btn btn-outline-secondary" :disabled="pending.habilitationsPersonnels"
                @click.prevent="loadMore()">
                <span v-if="pending.habilitationsPersonnels"><span class="spinner-border spinner-border-sm"></span>
                    Chargement...</span>
                <span v-else>Charger +</span>
            </button>
        </div>
    </template>
</template>

<script>
import { mapState } from 'vuex';
import AppMenuItem from '../pebble-ui/AppMenuItem.vue';
import ControlTodoHabilitationItem from './ControlTodoHabilitationItem.vue';
import LastControlFilterForm from "./LastControlFilterForm.vue";


export default {
    data() {
        return {
            collection: null,
            noMoreAvailable: false
        }
    },

    computed: {
        ...mapState(['habilitationsPersonnels', 'pending']),

        /**
         * Contrôle si il peut exister plus de résultats sur le serveurs que
         * de données stockées dans résults.
         *
         * On considère qu'il peut exister des résultats supplémentaires sur le serveur
         * à partir du moment ou il y a plus de 50 items dans result et que result / 50 est
         * égal à 1.
         *
         * @return {bool}
         */
        isMoreAvailable() {
            let ln = this.habilitationsPersonnels.length;
            return (ln && ln % this.collection.requestPayload?.limit === 0 && !this.noMoreAvailable);
        },

        /**
         * Retourne true lorsque la vue est prête à être affichée
         * 
         * @return {bool}
         */
        isReady() {
            return this.collection ? true : false;
        },

        /**
         * Retourne true lorsqu'il n'y a pas de résultats
         * 
         * @return {boolean}
         */
        noResults() {
            return !this.pending.habilitationsPersonnels && !this.habilitationsPersonnels?.length ? true : false;
        }
    },

    methods: {
        /**
         * Charger plus de resultats
         */
        async loadMore() {
            const start = this.collection.requestPayload.start ? this.collection.requestPayload.start + this.collection.requestPayload.limit : this.collection.requestPayload.limit ;
            this.collection.requestPayload.start = start;
            try {
                const data = await this.collection.load();
                if (!data.length) this.noMoreAvailable = true;
            }
            catch (e) {
                this.$app.catchError(e);
            }
        },

        // getHabilitations(){
        //     let query = {
        //         id : 0,
        //         personnel_id : 0,
        //         habilitation_type_id : 0,
        //         active : false,
        //         structure : 3,
        //     }
        //     this.$app.apiGet('/v2/habilitation', query)
        //     .then((data) => {
        //         console.log(data);
        //     }).catch(this.$app.catchError);
        // }
    },

    mounted() {
        this.collection = this.$assets.getCollection("habilitationsPersonnels");
    },

    components: { LastControlFilterForm, AppMenuItem, ControlTodoHabilitationItem }
}

</script>